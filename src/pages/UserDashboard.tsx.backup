import { useState, useEffect } from "react";
import { Link, useLocation } from "react-router-dom";
import { motion } from "framer-motion";
import {
  User,
  Calendar,
  Car,
  Settings,
  LogOut,
  Clock,
  CheckCircle,
  XCircle,
  Star,
  Edit,
  Save,
  X,
  Camera,
  Phone,
  MapPin,
  CreditCard,
  FileText,
  UserCircle,
  Mail,
  Shield,
  Bell,
  Sparkles,
  Send,
  MessageCircle,
  ChevronDown,
  ChevronUp,
  Plus,
  AlertCircle,
} from "lucide-react";
import Navbar from "@/components/Navbar";
import Footer from "@/components/Footer";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { bookings, vehicles, users } from "@/lib/data";
import { toast } from "sonner";
import { useAuth } from "@/contexts/AuthContext";

interface Review {
  id: number;
  name: string;
  rating: number;
  comment: string;
  date: string;
  status: 'pending' | 'approved';
  vehicleId: number;
  vehicleName: string;
  userId: number | null;
  userEmail: string | null;
}

interface MessageReply {
  id: number;
  replyText: string;
  senderType: 'ADMIN' | 'USER';
  senderName: string;
  senderEmail: string;
  createdAt: string;
  isRead: boolean;
}

interface ContactMessage {
  id: number;
  name: string;
  email: string;
  phone?: string;
  subject: string;
  message: string;
  status: 'NEW' | 'READ' | 'REPLIED' | 'ARCHIVED';
  createdAt: string;
  repliedAt?: string;
  adminReply?: string;
  replies?: MessageReply[];
}

// Removed complaints - use Contact page instead

const UserDashboard = () => {
  const location = useLocation();
  const [activeTab, setActiveTab] = useState("bookings");
  const [isEditingProfile, setIsEditingProfile] = useState(false);
  const [isChangingPassword, setIsChangingPassword] = useState(false);
  const [userBookings, setUserBookings] = useState<any[]>([]);
  const [isLoadingBookings, setIsLoadingBookings] = useState(true);
  const [userReviews, setUserReviews] = useState<Review[]>([]);
  const [contactMessages, setContactMessages] = useState<ContactMessage[]>([]);
  const [replyInputs, setReplyInputs] = useState<{ [key: number]: string }>({});
  const [sendingReply, setSendingReply] = useState<number | null>(null);
  const [expandedMessages, setExpandedMessages] = useState<Set<number>>(new Set());
  const chatEndRefs = useRef<{ [key: number]: HTMLDivElement | null }>({});
  const [selectedBooking, setSelectedBooking] = useState<any>(null);
  const [showBookingDetails, setShowBookingDetails] = useState(false);
  const { user, logout } = useAuth();
  
  // Handle notification navigation - set active tab from location state
  useEffect(() => {
    if (location.state?.activeTab) {
      setActiveTab(location.state.activeTab);
      // Clear the state after using it
      window.history.replaceState({}, document.title);
    }
  }, [location]);
  
  // User Settings State - must be declared before useEffect
  const [emailNotifications, setEmailNotifications] = useState(true);
  const [smsNotifications, setSmsNotifications] = useState(true);
  const [promotionalEmails, setPromotionalEmails] = useState(false);
  const [profileVisibility, setProfileVisibility] = useState(true);
  const [showBookingHistory, setShowBookingHistory] = useState(false);
  const [language, setLanguage] = useState("English");
  const [currency, setCurrency] = useState("USD");
  const [isSavingSettings, setIsSavingSettings] = useState(false);
  
  const [passwordData, setPasswordData] = useState({
    currentPassword: "",
    newPassword: "",
    confirmPassword: "",
  });
  
  const [profileData, setProfileData] = useState({
    name: user?.name || "",
    email: user?.email || "",
    phone: "",
    profileImage: "",
    joinDate: "",
    totalBookings: 0,
    totalSpent: 0,
    role: "",
    status: "",
  });

  // Function to fetch user data (can be called from anywhere)
  const fetchUserData = async () => {
    if (!user?.id) return;
    
    try {
      const response = await fetch(`http://localhost:8090/api/users/${user.id}`, {
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("token")}`,
        },
      });

      if (response.ok) {
        const data = await response.json();
        setProfileData({
          name: data.name || user.name || "",
          email: data.email || user.email || "",
          phone: data.phone || "",
          profileImage: data.profileImage || "",
          joinDate: data.joinDate || "",
          totalBookings: data.totalBookings || 0,
          totalSpent: data.totalSpent || 0,
          role: data.role || user.role || "",
          status: data.status || "ACTIVE",
        });
      }
      
      // Also fetch bookings
      const bookingsResponse = await fetch(`http://localhost:8090/api/bookings/user/${user.id}`, {
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("token")}`,
        },
      });
      
      if (bookingsResponse.ok) {
        const bookingsData = await bookingsResponse.json();
        setUserBookings(bookingsData);
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
    }
  };

  // Fetch complete user data on mount
  useEffect(() => {
    fetchUserData();
    loadContactMessages();
  }, [user?.id]);

  // Load Contact Messages for the user
  const loadContactMessages = async () => {
    if (!user?.email) {
      console.log("Cannot load messages: User email not available");
      return;
    }

    try {
      const token = localStorage.getItem("token");
      
      if (!token) {
        console.log("Cannot load messages: No authentication token");
        return;
      }

      console.log("Loading contact messages for user:", user.email);

      const response = await fetch(`http://localhost:8090/api/contact/user/${encodeURIComponent(user.email)}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      console.log("Load messages response status:", response.status);

      if (response.ok) {
        const messages = await response.json();
        console.log("Messages loaded successfully:", messages.length, "messages");
        console.log("Sample message data:", messages[0]);
        
        // Load replies for each message
        const messagesWithReplies = await Promise.all(
          messages.map(async (message: ContactMessage) => {
            try {
              console.log(`Fetching replies for message ${message.id}...`);
              const repliesResponse = await fetch(
                `http://localhost:8090/api/contact/${message.id}/replies`,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                  },
                }
              );
              
              if (repliesResponse.ok) {
                const replies = await repliesResponse.json();
                console.log(`Loaded ${replies.length} replies for message ${message.id}:`, replies);
                return { ...message, replies };
              } else {
                console.error(`Failed to load replies for message ${message.id}:`, repliesResponse.status);
                return { ...message, replies: [] };
              }
            } catch (error) {
              console.error(`Error loading replies for message ${message.id}:`, error);
              return { ...message, replies: [] };
            }
          })
        );
        
        console.log("Final messages with replies:", messagesWithReplies);
        setContactMessages(messagesWithReplies);
      } else if (response.status === 403) {
        console.error("Access denied loading messages");
        toast.error("Access denied. Please log in again.");
      } else {
        const errorText = await response.text();
        console.error("Failed to load messages:", response.status, errorText);
      }
    } catch (error) {
      console.error("Error loading contact messages:", error);
      toast.error("Failed to load messages. Please refresh the page.");
    }
  };

  // Send Reply to Message
  const handleSendReply = async (messageId: number) => {
    const replyText = replyInputs[messageId]?.trim();
    if (!replyText) {
      toast.error("Please enter a reply message");
      return;
    }

    setSendingReply(messageId);

    try {
      const token = localStorage.getItem("token");
      
      if (!token) {
        toast.error("You must be logged in to send a reply");
        setSendingReply(null);
        return;
      }

      const replyData = {
        replyText,
        senderName: user?.name || "User",
        senderEmail: user?.email || "",
      };

      console.log("Sending reply to message:", messageId, replyData);

      const response = await fetch(`http://localhost:8090/api/contact/${messageId}/reply`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(replyData),
      });

      console.log("Reply response status:", response.status);

      if (response.ok) {
        const result = await response.json();
        console.log("Reply sent successfully:", result);
        toast.success("Reply sent successfully");
        setReplyInputs(prev => ({ ...prev, [messageId]: "" }));
        await loadContactMessages();
        
        // Scroll to bottom of chat
        setTimeout(() => {
          chatEndRefs.current[messageId]?.scrollIntoView({ behavior: 'smooth' });
        }, 100);
      } else {
        const errorText = await response.text();
        console.error("Failed to send reply:", response.status, errorText);
        toast.error(`Failed to send reply: ${response.status === 403 ? 'Access denied' : errorText || 'Please try again'}`);
      }
    } catch (error) {
      console.error("Error sending reply:", error);
      toast.error("An error occurred while sending the reply. Please check your connection.");
    } finally {
      setSendingReply(null);
    }
  };

  // Toggle Message Expansion
  const toggleMessageExpansion = (messageId: number) => {
    setExpandedMessages(prev => {
      const newSet = new Set(prev);
      if (newSet.has(messageId)) {
        newSet.delete(messageId);
      } else {
        newSet.add(messageId);
      }
      return newSet;
    });
  };

  // Format relative time like WhatsApp
  const formatRelativeTime = (dateString: string): string => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return "Just now";
    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };

  // Load user preferences
  useEffect(() => {
    const loadUserPreferences = async () => {
      if (!user?.id) return;
      
      try {
        const response = await fetch(`http://localhost:8090/api/preferences/${user.id}`, {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        });

        if (response.ok) {
          const prefs = await response.json();
          setEmailNotifications(prefs.emailNotifications ?? true);
          setSmsNotifications(prefs.smsNotifications ?? true);
          setPromotionalEmails(prefs.promotions ?? false);
          setProfileVisibility(prefs.profileVisibility ?? true);
          setShowBookingHistory(prefs.showBookingHistory ?? false);
          setLanguage(prefs.language ?? "English");
          setCurrency(prefs.currency ?? "USD");
        }
      } catch (error) {
        console.error("Error loading preferences:", error);
      }
    };

    loadUserPreferences();
  }, [user?.id]);

  // Fetch user bookings
  useEffect(() => {
    const fetchBookings = async () => {
      if (!user?.id) return;
      
      try {
        setIsLoadingBookings(true);
        const response = await fetch(`http://localhost:8090/api/bookings/user/${user.id}`, {
          headers: {
            "Authorization": `Bearer ${localStorage.getItem("token")}`,
          },
        });

        if (response.status === 403) {
          // 403 Forbidden - session expired or user doesn't exist
          toast.error("Session expired. Please log in again.");
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          window.location.href = "/auth";
          return;
        }

        if (!response.ok) {
          throw new Error("Failed to fetch bookings");
        }

        const data = await response.json();
        setUserBookings(data);
      } catch (error: any) {
        console.error("Error fetching bookings:", error);
        // Use mock data as fallback
        const mockBookings = bookings.filter((b) => b.userId === "1");
        setUserBookings(mockBookings);
      } finally {
        setIsLoadingBookings(false);
      }
    };

    fetchBookings();
  }, [user?.id]);

  // Load user reviews
  useEffect(() => {
    if (!user?.id) return;
    
    const storedReviews = localStorage.getItem(`user_reviews_${user.id}`);
    if (storedReviews) {
      setUserReviews(JSON.parse(storedReviews));
    }
  }, [user?.id, activeTab]);

  const handleProfileImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        toast.error("Image size must be less than 5MB");
        return;
      }
      if (!file.type.startsWith("image/")) {
        toast.error("Please select an image file");
        return;
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        setProfileData({ ...profileData, profileImage: reader.result as string });
      };
      reader.readAsDataURL(file);
    }
  };

  const handleUpdateProfile = async () => {
    try {
      // Validate phone if provided
      if (profileData.phone) {
        const cleanPhone = profileData.phone.replace(/[\s\-()]/g, "");
        if (!/^(\+?[1-9]\d{7,14})$/.test(cleanPhone)) {
          toast.error("Invalid phone number format");
          return;
        }
      }

      // TODO: Call backend API to update profile
      const response = await fetch(`http://localhost:8090/api/users/${user?.id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`,
        },
        body: JSON.stringify({
          name: profileData.name,
          email: profileData.email,
          phone: profileData.phone.replace(/[\s\-()]/g, ""),
        }),
      });

      if (!response.ok) throw new Error("Failed to update profile");

      toast.success("Profile updated successfully!");
      setIsEditingProfile(false);
      // Update local storage user data
      const updatedUser = { ...user, ...profileData };
      localStorage.setItem("user", JSON.stringify(updatedUser));
    } catch (error: any) {
      toast.error(error.message || "Failed to update profile");
    }
  };

  const handleChangePassword = async () => {
    if (passwordData.newPassword !== passwordData.confirmPassword) {
      toast.error("Passwords do not match");
      return;
    }

    if (passwordData.newPassword.length < 6) {
      toast.error("Password must be at least 6 characters");
      return;
    }

    try {
      // TODO: Call backend API to change password
      const response = await fetch(`http://localhost:8090/api/users/${user?.id}/change-password`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`,
        },
        body: JSON.stringify({
          currentPassword: passwordData.currentPassword,
          newPassword: passwordData.newPassword,
        }),
      });

      if (!response.ok) throw new Error("Failed to change password");

      toast.success("Password changed successfully!");
      setIsChangingPassword(false);
      setPasswordData({ currentPassword: "", newPassword: "", confirmPassword: "" });
    } catch (error: any) {
      toast.error(error.message || "Failed to change password");
    }
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "confirmed":
        return <Badge className="bg-success text-success-foreground">Confirmed</Badge>;
      case "pending":
        return <Badge variant="secondary">Pending</Badge>;
      case "completed":
        return <Badge variant="outline">Completed</Badge>;
      default:
        return <Badge>{status}</Badge>;
    }
  };

  const handleCancelBooking = async (bookingId: string) => {
    try {
      const response = await fetch(`http://localhost:8090/api/bookings/${bookingId}/cancel`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("token")}`,
        },
      });

      if (!response.ok) {
        throw new Error("Failed to cancel booking");
      }

      toast.success("Booking cancelled successfully");
      
      // Refresh bookings
      setUserBookings(userBookings.map(b => 
        b.id === bookingId ? { ...b, status: "cancelled" } : b
      ));
    } catch (error: any) {
      toast.error(error.message || "Failed to cancel booking");
    }
  };

  const handleConfirmPayment = async (bookingId: number) => {
    if (!confirm("Confirm that you have completed the payment for this booking?")) {
      return;
    }

    try {
      const token = localStorage.getItem("token");
      const response = await fetch(
        `http://localhost:8090/api/bookings/${bookingId}/confirm-payment`,
        {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      if (response.ok) {
        toast.success("Payment confirmed successfully");
        
        // Refresh user data to update booking list
        fetchUserData();
        setShowBookingDetails(false);
      } else {
        const error = await response.json();
        toast.error(error.message || "Failed to confirm payment");
      }
    } catch (error: any) {
      toast.error(error.message || "An error occurred");
    }
  };

  const handleSaveSettings = async () => {
    setIsSavingSettings(true);
    try {
      const token = localStorage.getItem("token");
      const response = await fetch(`http://localhost:8090/api/preferences/${user?.id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          emailNotifications,
          smsNotifications,
          promotions: promotionalEmails,
          profileVisibility,
          showBookingHistory,
          language,
          currency,
        }),
      });

      if (response.ok) {
        toast.success("Settings saved successfully!");
      } else {
        toast.error("Failed to save settings");
      }
    } catch (error) {
      console.error("Error saving settings:", error);
      toast.error("An error occurred while saving settings");
    } finally {
      setIsSavingSettings(false);
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <Navbar />

      <div className="pt-24 pb-16">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="mb-8"
          >
            <h1 className="text-3xl md:text-4xl font-bold mb-2">My Dashboard</h1>
            <p className="text-muted-foreground">Manage your bookings and account</p>
          </motion.div>

          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
            {/* Sidebar */}
            <motion.div
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              className="lg:col-span-1"
            >
              <Card className="p-6">
                <div className="flex flex-col items-center text-center mb-6">
                  <div className="relative w-24 h-24 mb-3">
                    {profileData.profileImage ? (
                      <img 
                        src={profileData.profileImage} 
                        alt={user?.name}
                        className="w-full h-full rounded-full object-cover border-4 border-primary/20"
                      />
                    ) : (
                      <div className="w-full h-full rounded-full bg-gradient-hero flex items-center justify-center text-primary-foreground text-2xl font-bold">
                        {user?.name.charAt(0).toUpperCase()}
                      </div>
                    )}
                  </div>
                  <h3 className="font-semibold text-lg">{user?.name}</h3>
                  <p className="text-sm text-muted-foreground">{user?.email}</p>
                  {profileData.phone && (
                    <p className="text-sm text-muted-foreground flex items-center gap-1 mt-1">
                      <Phone className="h-3 w-3" />
                      {profileData.phone}
                    </p>
                  )}
                  {profileData.joinDate && (
                    <p className="text-xs text-muted-foreground mt-2">
                      Member since {new Date(profileData.joinDate).toLocaleDateString()}
                    </p>
                  )}
                </div>

                <Separator className="my-6" />

                {/* User Stats */}
                <div className="space-y-4 mb-6">
                  <div className="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div className="flex items-center gap-2">
                      <Calendar className="h-4 w-4 text-primary" />
                      <span className="text-sm">Total Bookings</span>
                    </div>
                    <span className="font-semibold">{userBookings.length}</span>
                  </div>
                  <div className="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div className="flex items-center gap-2">
                      <CreditCard className="h-4 w-4 text-primary" />
                      <span className="text-sm">Total Spent</span>
                    </div>
                    <span className="font-semibold text-success">
                      ${profileData.totalSpent ? profileData.totalSpent.toFixed(2) : "0.00"}
                    </span>
                  </div>
                  <div className="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div className="flex items-center gap-2">
                      <Star className="h-4 w-4 text-primary" />
                      <span className="text-sm">Reviews</span>
                    </div>
                    <span className="font-semibold">{userReviews.length}</span>
                  </div>
                </div>

                <Separator className="my-6" />

                <nav className="space-y-2">
                  <button
                    onClick={() => setActiveTab("bookings")}
                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${
                      activeTab === "bookings"
                        ? "bg-primary text-primary-foreground"
                        : "hover:bg-muted"
                    }`}
                  >
                    <Calendar className="h-5 w-5" />
                    <span>My Bookings</span>
                  </button>

                  <button
                    onClick={() => setActiveTab("profile")}
                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${
                      activeTab === "profile"
                        ? "bg-primary text-primary-foreground"
                        : "hover:bg-muted"
                    }`}
                  >
                    <User className="h-5 w-5" />
                    <span>Profile</span>
                  </button>

                  <button
                    onClick={() => setActiveTab("reviews")}
                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${
                      activeTab === "reviews"
                        ? "bg-primary text-primary-foreground"
                        : "hover:bg-muted"
                    }`}
                  >
                    <Star className="h-5 w-5" />
                    <span>My Reviews</span>
                  </button>

                  <button
                    onClick={() => setActiveTab("messages")}
                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${
                      activeTab === "messages"
                        ? "bg-primary text-primary-foreground"
                        : "hover:bg-muted"
                    }`}
                  >
                    <MessageCircle className="h-5 w-5" />
                    <span>Messages & Support</span>
                    {(() => {
                      const newRepliesCount = contactMessages.reduce((count, msg) => {
                        if (!msg.replies) return count;
                        const unreadAdminReplies = msg.replies.filter(
                          reply => reply.senderType === 'ADMIN' && !reply.isRead
                        ).length;
                        return count + unreadAdminReplies;
                      }, 0);
                      
                      return newRepliesCount > 0 ? (
                        <Badge className="ml-auto bg-green-500 text-white">
                          {newRepliesCount}
                        </Badge>
                      ) : null;
                    })()}
                  </button>

                  <button
                    onClick={() => setActiveTab("settings")}
                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${
                      activeTab === "settings"
                        ? "bg-primary text-primary-foreground"
                        : "hover:bg-muted"
                    }`}
                  >
                    <Settings className="h-5 w-5" />
                    <span>Settings</span>
                  </button>

                  <Link to="/vehicles">
                    <button className="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-muted transition-colors">
                      <Car className="h-5 w-5" />
                      <span>Browse Vehicles</span>
                    </button>
                  </Link>
                </nav>

                <Separator className="my-6" />

                <Button 
                  variant="ghost" 
                  className="w-full justify-start"
                  onClick={logout}
                >
                  <LogOut className="h-5 w-5 mr-3" />
                  Sign Out
                </Button>
              </Card>
            </motion.div>

            {/* Main Content */}
            <motion.div
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              className="lg:col-span-3"
            >
              {/* Bookings Tab */}
              {activeTab === "bookings" && (
                <div className="space-y-6">
                  {/* Stats */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <Card className="p-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-muted-foreground mb-1">Total Bookings</p>
                          <p className="text-2xl font-bold">{userBookings.length}</p>
                        </div>
                        <div className="bg-primary/10 p-3 rounded-lg">
                          <Calendar className="h-6 w-6 text-primary" />
                        </div>
                      </div>
                    </Card>

                    <Card className="p-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-muted-foreground mb-1">Active Bookings</p>
                          <p className="text-2xl font-bold">
                            {userBookings.filter((b) => b.status === "confirmed").length}
                          </p>
                        </div>
                        <div className="bg-success/10 p-3 rounded-lg">
                          <CheckCircle className="h-6 w-6 text-success" />
                        </div>
                      </div>
                    </Card>

                    <Card className="p-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-muted-foreground mb-1">Pending</p>
                          <p className="text-2xl font-bold">
                            {userBookings.filter((b) => b.status === "pending").length}
                          </p>
                        </div>
                        <div className="bg-warning/10 p-3 rounded-lg">
                          <Clock className="h-6 w-6 text-warning" />
                        </div>
                      </div>
                    </Card>
                  </div>

                  {/* Bookings List */}
                  <Card className="p-6">
                    <h2 className="text-xl font-semibold mb-6">My Bookings</h2>
                    
                    {isLoadingBookings ? (
                      <div className="flex items-center justify-center py-12">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                      </div>
                    ) : userBookings.length === 0 ? (
                      <div className="text-center py-12">
                        <Car className="h-16 w-16 mx-auto text-muted-foreground mb-4 opacity-50" />
                        <p className="text-muted-foreground mb-4">You don't have any bookings yet</p>
                        <Link to="/vehicles">
                          <Button variant="hero">
                            Browse Vehicles
                          </Button>
                        </Link>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {userBookings.map((booking) => {
                          const vehicle = vehicles.find((v) => v.id === booking.vehicleId || v.id === String(booking.vehicleId));
                          
                          return (
                            <div
                              key={booking.id}
                              className="border rounded-xl p-4 hover-lift"
                            >
                              <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div className="flex items-start space-x-4">
                                  {vehicle && (
                                    <div className="w-20 h-20 bg-muted rounded-lg overflow-hidden flex-shrink-0">
                                      <img
                                        src={vehicle.image}
                                        alt={vehicle.name}
                                        className="w-full h-full object-cover"
                                      />
                                    </div>
                                  )}
                                  <div>
                                    <h3 className="font-semibold mb-1">
                                      {vehicle ? vehicle.name : `Vehicle #${booking.vehicleId}`}
                                    </h3>
                                    <p className="text-sm text-muted-foreground mb-2">
                                      Booking ID: {booking.id}
                                    </p>
                                    <div className="flex flex-wrap gap-2 text-sm">
                                      <span className="flex items-center text-muted-foreground">
                                        <Calendar className="h-3 w-3 mr-1" />
                                        {booking.startDate} - {booking.endDate}
                                      </span>
                                    </div>
                                    <p className="text-sm text-muted-foreground mt-2">
                                      {booking.pickupLocation} â†’ {booking.dropoffLocation || booking.dropOffLocation}
                                    </p>
                                  </div>
                                </div>
                                <div className="flex flex-col items-end space-y-2">
                                  {getStatusBadge(booking.status)}
                                  
                                  {/* Payment Status Badge */}
                                  {booking.paymentStatus && (
                                    <Badge 
                                      variant={
                                        booking.paymentStatus === "COMPLETED" || booking.paymentStatus === "completed"
                                          ? "default" 
                                          : "secondary"
                                      }
                                      className={
                                        booking.paymentStatus === "COMPLETED" || booking.paymentStatus === "completed"
                                          ? "bg-green-100 text-green-700 border-green-300"
                                          : "bg-orange-100 text-orange-700 border-orange-300"
                                      }
                                    >
                                      {booking.paymentStatus === "COMPLETED" || booking.paymentStatus === "completed" 
                                        ? "Paid" 
                                        : "Payment Pending"}
                                    </Badge>
                                  )}
                                  
                                  <div className="text-2xl font-bold text-primary">
                                    ${booking.totalPrice}
                                  </div>
                                  <div className="flex gap-2">
                                    <Button 
                                      variant="outline" 
                                      size="sm"
                                      onClick={() => {
                                        setSelectedBooking(booking);
                                        setShowBookingDetails(true);
                                      }}
                                    >
                                      View Details
                                    </Button>
                                    
                                    {/* Confirm Payment Button for completed bookings */}
                                    {(booking.status === "completed" || booking.status === "COMPLETED") && 
                                     (booking.paymentStatus === "pending" || booking.paymentStatus === "PENDING") && (
                                      <Button
                                        variant="default"
                                        size="sm"
                                        className="bg-green-600 hover:bg-green-700"
                                        onClick={() => handleConfirmPayment(booking.id)}
                                      >
                                        <CreditCard className="h-3 w-3 mr-1" />
                                        Pay
                                      </Button>
                                    )}
                                    
                                    {(booking.status === "confirmed" || booking.status === "CONFIRMED" || booking.status === "pending" || booking.status === "PENDING") && (
                                      <Button
                                        variant="destructive"
                                        size="sm"
                                        onClick={() => handleCancelBooking(booking.id)}
                                      >
                                        Cancel
                                      </Button>
                                    )}
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </Card>
                </div>
              )}

              {/* Profile Tab */}
              {activeTab === "profile" && (
                <div className="space-y-6">
                  {/* Profile Information */}
                  <Card className="p-6">
                    <div className="flex items-center justify-between mb-6">
                      <h2 className="text-xl font-semibold">Profile Information</h2>
                      {!isEditingProfile && (
                        <Button 
                          variant="outline" 
                          size="sm"
                          onClick={() => setIsEditingProfile(true)}
                        >
                          <Edit className="h-4 w-4 mr-2" />
                          Edit
                        </Button>
                      )}
                    </div>
                    
                    {isEditingProfile ? (
                      <div className="space-y-4">
                        {/* Profile Image Upload */}
                        <div className="flex flex-col items-center">
                          <div className="relative w-32 h-32 mb-3">
                            {profileData.profileImage ? (
                              <img 
                                src={profileData.profileImage} 
                                alt="Profile"
                                className="w-full h-full rounded-full object-cover border-4 border-primary/20"
                              />
                            ) : (
                              <div className="w-full h-full rounded-full bg-gradient-hero flex items-center justify-center text-primary-foreground text-3xl font-bold">
                                {user?.name.charAt(0).toUpperCase()}
                              </div>
                            )}
                            <label 
                              htmlFor="profileImage" 
                              className="absolute bottom-0 right-0 bg-primary text-primary-foreground p-2 rounded-full cursor-pointer hover:bg-primary/90 transition-colors"
                            >
                              <Camera className="h-4 w-4" />
                            </label>
                            <input
                              id="profileImage"
                              type="file"
                              accept="image/*"
                              className="hidden"
                              onChange={handleProfileImageChange}
                            />
                          </div>
                          <p className="text-xs text-muted-foreground">Click camera icon to upload (Max 5MB)</p>
                        </div>
                        
                        <Separator />
                        
                        <div>
                          <Label htmlFor="name">Full Name</Label>
                          <Input
                            id="name"
                            value={profileData.name}
                            onChange={(e) => setProfileData({ ...profileData, name: e.target.value })}
                            className="mt-1"
                            required
                          />
                        </div>
                        <div>
                          <Label htmlFor="email">Email</Label>
                          <Input
                            id="email"
                            type="email"
                            value={profileData.email}
                            onChange={(e) => setProfileData({ ...profileData, email: e.target.value })}
                            className="mt-1"
                            required
                          />
                        </div>
                        <div>
                          <Label htmlFor="phone">Phone Number</Label>
                          <div className="relative mt-1">
                            <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                            <Input
                              id="phone"
                              type="tel"
                              value={profileData.phone}
                              onChange={(e) => setProfileData({ ...profileData, phone: e.target.value })}
                              placeholder="Enter phone (e.g., +94712345678)"
                              className="pl-10"
                            />
                          </div>
                        </div>
                        <div className="flex gap-2 pt-4">
                          <Button onClick={handleUpdateProfile}>
                            <Save className="h-4 w-4 mr-2" />
                            Save Changes
                          </Button>
                          <Button 
                            variant="outline" 
                            onClick={() => {
                              setIsEditingProfile(false);
                              setProfileData({ 
                                name: user?.name || "", 
                                email: user?.email || "",
                                phone: "",
                                profileImage: "",
                                joinDate: "",
                                totalBookings: 0,
                                totalSpent: 0,
                                role: user?.role || "",
                                status: "ACTIVE",
                              });
                            }}
                          >
                            <X className="h-4 w-4 mr-2" />
                            Cancel
                          </Button>
                        </div>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {/* Profile Image Display */}
                        <div className="flex justify-center mb-4">
                          {profileData.profileImage ? (
                            <img 
                              src={profileData.profileImage} 
                              alt="Profile"
                              className="w-32 h-32 rounded-full object-cover border-4 border-primary/20"
                            />
                          ) : (
                            <div className="w-32 h-32 rounded-full bg-gradient-hero flex items-center justify-center text-primary-foreground text-3xl font-bold">
                              {user?.name.charAt(0).toUpperCase()}
                            </div>
                          )}
                        </div>
                        
                        <Separator />
                        
                        <div>
                          <label className="text-sm font-medium text-muted-foreground">Name</label>
                          <p className="mt-1 text-lg">{user?.name}</p>
                        </div>
                        <Separator />
                        <div>
                          <label className="text-sm font-medium text-muted-foreground">Email</label>
                          <p className="mt-1 text-lg">{user?.email}</p>
                        </div>
                        <Separator />
                        <div>
                          <label className="text-sm font-medium text-muted-foreground">Phone</label>
                          <p className="mt-1 text-lg">{profileData.phone || "Not provided"}</p>
                        </div>
                        <Separator />
                        <div>
                          <label className="text-sm font-medium text-muted-foreground">Role</label>
                          <Badge className="mt-2 bg-primary">
                            {profileData.role || user?.role}
                          </Badge>
                        </div>
                        <Separator />
                        <div>
                          <label className="text-sm font-medium text-muted-foreground">Account Status</label>
                          <Badge className="mt-2" variant={profileData.status === "ACTIVE" ? "default" : "secondary"}>
                            {profileData.status || "ACTIVE"}
                          </Badge>
                        </div>
                        <Separator />
                        <div>
                          <label className="text-sm font-medium text-muted-foreground">Member Since</label>
                          <p className="mt-1 text-lg">
                            {profileData.joinDate ? new Date(profileData.joinDate).toLocaleDateString('en-US', { 
                              year: 'numeric', 
                              month: 'long', 
                              day: 'numeric' 
                            }) : "N/A"}
                          </p>
                        </div>
                        <Separator />
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="text-sm font-medium text-muted-foreground">Total Bookings</label>
                            <p className="mt-1 text-2xl font-bold text-primary">{profileData.totalBookings}</p>
                          </div>
                          <div>
                            <label className="text-sm font-medium text-muted-foreground">Total Spent</label>
                            <p className="mt-1 text-2xl font-bold text-success">
                              ${profileData.totalSpent ? profileData.totalSpent.toFixed(2) : "0.00"}
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </Card>

                  {/* Change Password */}
                  <Card className="p-6">
                    <div className="flex items-center justify-between mb-6">
                      <h2 className="text-xl font-semibold">Change Password</h2>
                      {!isChangingPassword && (
                        <Button 
                          variant="outline" 
                          size="sm"
                          onClick={() => setIsChangingPassword(true)}
                        >
                          <Edit className="h-4 w-4 mr-2" />
                          Change
                        </Button>
                      )}
                    </div>
                    
                    {isChangingPassword ? (
                      <div className="space-y-4">
                        <div>
                          <Label htmlFor="currentPassword">Current Password</Label>
                          <Input
                            id="currentPassword"
                            type="password"
                            value={passwordData.currentPassword}
                            onChange={(e) => setPasswordData({ ...passwordData, currentPassword: e.target.value })}
                            className="mt-1"
                          />
                        </div>
                        <div>
                          <Label htmlFor="newPassword">New Password</Label>
                          <Input
                            id="newPassword"
                            type="password"
                            value={passwordData.newPassword}
                            onChange={(e) => setPasswordData({ ...passwordData, newPassword: e.target.value })}
                            className="mt-1"
                            minLength={6}
                          />
                        </div>
                        <div>
                          <Label htmlFor="confirmPassword">Confirm New Password</Label>
                          <Input
                            id="confirmPassword"
                            type="password"
                            value={passwordData.confirmPassword}
                            onChange={(e) => setPasswordData({ ...passwordData, confirmPassword: e.target.value })}
                            className="mt-1"
                            minLength={6}
                          />
                        </div>
                        <div className="flex gap-2 pt-4">
                          <Button onClick={handleChangePassword}>
                            <Save className="h-4 w-4 mr-2" />
                            Update Password
                          </Button>
                          <Button 
                            variant="outline" 
                            onClick={() => {
                              setIsChangingPassword(false);
                              setPasswordData({ currentPassword: "", newPassword: "", confirmPassword: "" });
                            }}
                          >
                            <X className="h-4 w-4 mr-2" />
                            Cancel
                          </Button>
                        </div>
                      </div>
                    ) : (
                      <p className="text-muted-foreground">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</p>
                    )}
                  </Card>

                </div>
              )}

              {/* Messages Tab */}
              {activeTab === "messages" && (
                <div className="space-y-6">
                  <Card className="p-6">
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <h2 className="text-xl font-semibold">My Messages & Support</h2>
                        <p className="text-sm text-muted-foreground mt-1">View and reply to conversations with our support team</p>
                      </div>
                      {(() => {
                        const newRepliesCount = contactMessages.reduce((count, msg) => {
                          if (!msg.replies) return count;
                          const unreadAdminReplies = msg.replies.filter(
                            reply => reply.senderType === 'ADMIN' && !reply.isRead
                          ).length;
                          return count + unreadAdminReplies;
                        }, 0);
                        
                        return newRepliesCount > 0 ? (
                          <Badge className="bg-green-500 text-white flex items-center gap-1">
                            <Bell className="h-3 w-3" />
                            {newRepliesCount} New {newRepliesCount === 1 ? 'Reply' : 'Replies'}
                          </Badge>
                        ) : null;
                      })()}
                    </div>
                    
                    {contactMessages.length > 0 ? (
                      <div className="space-y-4">
                        {contactMessages.map((message) => {
                          const isExpanded = expandedMessages.has(message.id);
                          const hasReplies = message.replies && message.replies.length > 0;
                          const replyCount = message.replies?.length || 0;
                          
                          return (
                          <motion.div
                            key={message.id}
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ duration: 0.3 }}
                          >
                          <Card className={`p-4 border-l-4 ${
                            hasReplies ? 'border-l-green-500 bg-green-50/30' : 'border-l-primary'
                          }`}>
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <div className="flex items-center gap-2">
                                  <h3 className="font-semibold text-lg">{message.subject}</h3>
                                  {hasReplies && (
                                    <Badge variant="outline" className="bg-green-100 text-green-700">
                                      <MessageCircle className="h-3 w-3 mr-1" />
                                      {replyCount} {replyCount === 1 ? 'reply' : 'replies'}
                                    </Badge>
                                  )}
                                </div>
                                <p className="text-xs text-muted-foreground mt-1">
                                  Started {new Date(message.createdAt).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                  })}
                                </p>
                              </div>
                              <div className="flex items-center gap-2">
                                <Badge
                                  variant={
                                    message.status === 'NEW' ? 'default' :
                                    message.status === 'READ' ? 'secondary' :
                                    message.status === 'REPLIED' ? 'outline' : 'secondary'
                                  }
                                  className={
                                    message.status === 'NEW' ? 'bg-blue-500' :
                                    message.status === 'REPLIED' ? 'bg-green-500 text-white' : ''
                                  }
                                >
                                  {message.status}
                                </Badge>
                              </div>
                            </div>

                            {/* WhatsApp-Style Chat Interface */}
                            <div className="relative mb-3 h-[500px] flex flex-col">
                              {/* Chat Header */}
                              <div className="bg-gradient-to-r from-green-600 to-green-500 text-white px-4 py-3 rounded-t-lg flex items-center gap-3 shadow-md">
                                <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                  <MessageCircle className="h-5 w-5" />
                                </div>
                                <div className="flex-1">
                                  <h4 className="font-semibold text-sm">{message.subject}</h4>
                                  <p className="text-xs opacity-90">Support Conversation</p>
                                </div>
                              </div>

                              {/* Chat Messages Area */}
                              <div className="flex-1 overflow-y-auto p-4 bg-gradient-to-b from-gray-50 to-white space-y-2 rounded-b-lg border border-t-0">
                                {/* Original Message - User */}
                                <motion.div
                                  initial={{ opacity: 0, x: 20 }}
                                  animate={{ opacity: 1, x: 0 }}
                                  className="flex justify-end mb-4"
                                >
                                  <div className="max-w-[75%]">
                                    <div className="flex items-center gap-2 mb-1 px-2 justify-end">
                                      <span className="text-xs font-medium text-gray-600">You</span>
                                    </div>
                                    <div className="bg-blue-500 text-white rounded-2xl rounded-tr-sm px-4 py-2 shadow-sm">
                                      <p className="text-sm whitespace-pre-wrap break-words">{message.message}</p>
                                      <div className="flex items-center justify-end gap-1 mt-1">
                                        <span className="text-[10px] opacity-70">
                                          {formatRelativeTime(message.createdAt)}
                                        </span>
                                      </div>
                                    </div>
                                  </div>
                                </motion.div>

                                {/* All Replies - Grouped by consecutive sender */}
                                {message.replies && message.replies.length > 0 && (() => {
                                  console.log(`ðŸ”µ User Dashboard - Rendering ${message.replies.length} replies for message ${message.id}:`, message.replies);
                                  return message.replies.map((reply, index) => {
                                    console.log(`  ðŸ“© Reply ${index + 1}:`, { 
                                      id: reply.id, 
                                      senderType: reply.senderType, 
                                      senderName: reply.senderName, 
                                      senderEmail: reply.senderEmail,
                                      text: reply.replyText?.substring(0, 50) 
                                    });
                                    const isAdmin = reply.senderType === 'ADMIN';
                                    console.log(`  ðŸŽ¯ isAdmin check: senderType="${reply.senderType}" â†’ isAdmin=${isAdmin}`);
                                    const prevReply = index > 0 ? message.replies[index - 1] : null;
                                    const isSameSender = prevReply && prevReply.senderType === reply.senderType;
                                    const timeDiff = prevReply ? new Date(reply.createdAt).getTime() - new Date(prevReply.createdAt).getTime() : 0;
                                    const isGrouped = isSameSender && timeDiff < 60000; // Group if within 1 minute

                                    return (
                                    <motion.div
                                      key={reply.id}
                                      initial={{ opacity: 0, x: isAdmin ? -20 : 20 }}
                                      animate={{ opacity: 1, x: 0 }}
                                      transition={{ delay: index * 0.05 }}
                                      className={`flex ${isAdmin ? 'justify-start' : 'justify-end'} ${isGrouped ? 'mt-1' : 'mt-4'}`}
                                    >
                                      <div className="max-w-[75%]">
                                        {!isGrouped && (
                                          <div className={`flex items-center gap-2 mb-1 px-2 ${isAdmin ? '' : 'justify-end'}`}>
                                            {isAdmin && <Shield className="h-3 w-3 text-green-600" />}
                                            <span className="text-xs font-medium text-gray-600">
                                              {isAdmin ? 'Admin Support' : 'You'}
                                            </span>
                                          </div>
                                        )}
                                        <div className={`${
                                          isAdmin 
                                            ? 'bg-white border border-gray-200 text-gray-800 rounded-2xl rounded-tl-sm'
                                            : 'bg-blue-500 text-white rounded-2xl rounded-tr-sm'
                                        } px-4 py-2 shadow-sm`}>
                                          <p className="text-sm whitespace-pre-wrap break-words">{reply.replyText}</p>
                                          <div className={`flex items-center ${isAdmin ? 'justify-start' : 'justify-end'} gap-1 mt-1`}>
                                            <span className={`text-[10px] ${isAdmin ? 'text-gray-500' : 'text-white/70'}`}>
                                              {formatRelativeTime(reply.createdAt)}
                                            </span>
                                          </div>
                                        </div>
                                      </div>
                                    </motion.div>
                                    );
                                  });
                                })()}
                                
                                {/* Show message when no replies yet */}
                                {(!message.replies || message.replies.length === 0) && (
                                  <div className="flex justify-center py-6">
                                    <div className="text-center text-gray-400">
                                      <MessageCircle className="h-8 w-8 mx-auto mb-2 opacity-50" />
                                      <p className="text-sm">No replies yet. Send a message below to continue the conversation.</p>
                                    </div>
                                  </div>
                                )}
                                
                                {/* Invisible div for auto-scroll */}
                                <div ref={(el) => chatEndRefs.current[message.id] = el} />
                              </div>
                            </div>

                            {/* WhatsApp-Style Reply Input */}
                            <div className="mt-3">
                              <div className="flex gap-2 items-end bg-white rounded-full shadow-md border border-gray-200 px-4 py-2">
                                <Input
                                  placeholder="Type a message..."
                                  value={replyInputs[message.id] || ''}
                                  onChange={(e) => setReplyInputs(prev => ({
                                    ...prev,
                                    [message.id]: e.target.value
                                  }))}
                                  onKeyPress={(e) => {
                                    if (e.key === 'Enter' && !e.shiftKey) {
                                      e.preventDefault();
                                      handleSendReply(message.id);
                                    }
                                  }}
                                  disabled={sendingReply === message.id}
                                  className="flex-1 border-0 focus-visible:ring-0 focus-visible:ring-offset-0 bg-transparent"
                                />
                                <Button
                                  onClick={() => handleSendReply(message.id)}
                                  disabled={!replyInputs[message.id]?.trim() || sendingReply === message.id}
                                  size="sm"
                                  className="rounded-full w-10 h-10 p-0 bg-green-500 hover:bg-green-600"
                                >
                                  {sendingReply === message.id ? (
                                    <Clock className="h-4 w-4 animate-spin" />
                                  ) : (
                                    <Send className="h-4 w-4" />
                                  )}
                                </Button>
                              </div>
                            </div>

                            {!hasReplies && message.status !== 'REPLIED' && (
                              <div className="mt-3 pt-3 border-t">
                                <p className="text-xs text-muted-foreground flex items-center gap-2">
                                  <Clock className="h-3 w-3" />
                                  {message.status === 'NEW' ? 'Waiting for admin response...' : 'Your message has been read by our team'}
                                </p>
                              </div>
                            )}
                          </Card>
                          </motion.div>
                        );
                        })}
                      </div>
                    ) : (
                      <div className="text-center py-8">
                        <Mail className="h-12 w-12 text-muted-foreground mx-auto mb-3" />
                        <p className="text-muted-foreground mb-2">No messages yet</p>
                        <p className="text-sm text-muted-foreground">
                          Contact us through the <Link to="/contact" className="text-primary hover:underline">Contact page</Link> if you need help
                        </p>
                      </div>
                    )}
                  </Card>
                </div>
              )}

              {/* Settings Tab */}
              {activeTab === "settings" && (
                <div className="space-y-6">
                  <Card className="p-6">
                    <h2 className="text-xl font-semibold mb-6">Account Settings</h2>
                    <div className="space-y-6">
                      {/* Notifications */}
                      <div>
                        <h3 className="text-lg font-medium mb-4">Notifications</h3>
                        <div className="space-y-3">
                          <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div>
                              <p className="font-medium">Email Notifications</p>
                              <p className="text-sm text-muted-foreground">Receive booking updates via email</p>
                            </div>
                            <input 
                              type="checkbox" 
                              checked={emailNotifications}
                              onChange={(e) => setEmailNotifications(e.target.checked)}
                              className="h-5 w-5 rounded" 
                            />
                          </div>
                          <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div>
                              <p className="font-medium">SMS Notifications</p>
                              <p className="text-sm text-muted-foreground">Receive booking updates via SMS</p>
                            </div>
                            <input 
                              type="checkbox" 
                              checked={smsNotifications}
                              onChange={(e) => setSmsNotifications(e.target.checked)}
                              className="h-5 w-5 rounded" 
                            />
                          </div>
                          <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div>
                              <p className="font-medium">Promotional Emails</p>
                              <p className="text-sm text-muted-foreground">Receive special offers and promotions</p>
                            </div>
                            <input 
                              type="checkbox" 
                              checked={promotionalEmails}
                              onChange={(e) => setPromotionalEmails(e.target.checked)}
                              className="h-5 w-5 rounded" 
                            />
                          </div>
                        </div>
                      </div>

                      <Separator />

                      {/* Privacy */}
                      <div>
                        <h3 className="text-lg font-medium mb-4">Privacy</h3>
                        <div className="space-y-3">
                          <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div>
                              <p className="font-medium">Profile Visibility</p>
                              <p className="text-sm text-muted-foreground">Make your profile visible to others</p>
                            </div>
                            <input 
                              type="checkbox" 
                              checked={profileVisibility}
                              onChange={(e) => setProfileVisibility(e.target.checked)}
                              className="h-5 w-5 rounded" 
                            />
                          </div>
                          <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div>
                              <p className="font-medium">Show Booking History</p>
                              <p className="text-sm text-muted-foreground">Display your booking history on profile</p>
                            </div>
                            <input 
                              type="checkbox" 
                              checked={showBookingHistory}
                              onChange={(e) => setShowBookingHistory(e.target.checked)}
                              className="h-5 w-5 rounded" 
                            />
                          </div>
                        </div>
                      </div>

                      <Separator />

                      {/* Language & Region */}
                      <div>
                        <h3 className="text-lg font-medium mb-4">Language & Region</h3>
                        <div className="space-y-3">
                          <div className="space-y-2">
                            <Label>Language</Label>
                            <select 
                              className="w-full p-2 border rounded-lg"
                              value={language}
                              onChange={(e) => setLanguage(e.target.value)}
                            >
                              <option>English</option>
                              <option>Spanish</option>
                              <option>French</option>
                              <option>German</option>
                            </select>
                          </div>
                          <div className="space-y-2">
                            <Label>Currency</Label>
                            <select 
                              className="w-full p-2 border rounded-lg"
                              value={currency}
                              onChange={(e) => setCurrency(e.target.value)}
                            >
                              <option value="USD">USD ($)</option>
                              <option value="EUR">EUR (â‚¬)</option>
                              <option value="GBP">GBP (Â£)</option>
                              <option value="JPY">JPY (Â¥)</option>
                            </select>
                          </div>
                        </div>
                      </div>

                      <Separator />

                      {/* Danger Zone */}
                      <div>
                        <h3 className="text-lg font-medium mb-4 text-destructive">Danger Zone</h3>
                        <div className="space-y-3">
                          <div className="p-4 border border-destructive rounded-lg">
                            <p className="font-medium mb-2">Delete Account</p>
                            <p className="text-sm text-muted-foreground mb-4">Once you delete your account, there is no going back. Please be certain.</p>
                            <Button variant="destructive" size="sm">
                              Delete Account
                            </Button>
                          </div>
                        </div>
                      </div>

                      <div className="flex justify-end gap-2 pt-4">
                        <Button variant="outline" onClick={() => setActiveTab("bookings")}>Cancel</Button>
                        <Button onClick={handleSaveSettings} disabled={isSavingSettings}>
                          {isSavingSettings ? "Saving..." : "Save Settings"}
                        </Button>
                      </div>
                    </div>
                  </Card>
                </div>
              )}

              {/* Reviews Tab */}
              {activeTab === "reviews" && (
                <Card className="p-6">
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-xl font-semibold">My Reviews</h2>
                    <div className="flex gap-2">
                      <Badge variant="secondary">
                        Total: {userReviews.length}
                      </Badge>
                      <Badge variant="outline" className="bg-yellow-50 text-yellow-700 border-yellow-200">
                        Pending: {userReviews.filter(r => r.status === 'pending').length}
                      </Badge>
                      <Badge variant="outline" className="bg-green-50 text-green-700 border-green-200">
                        Approved: {userReviews.filter(r => r.status === 'approved').length}
                      </Badge>
                    </div>
                  </div>

                  {userReviews.length > 0 ? (
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Vehicle</TableHead>
                          <TableHead>Rating</TableHead>
                          <TableHead>Comment</TableHead>
                          <TableHead>Date</TableHead>
                          <TableHead>Status</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {userReviews
                          .sort((a, b) => b.id - a.id) // Newest first
                          .map((review) => (
                            <TableRow key={review.id}>
                              <TableCell className="font-medium">
                                {review.vehicleName}
                              </TableCell>
                              <TableCell>
                                <div className="flex items-center gap-1">
                                  {[1, 2, 3, 4, 5].map((star) => (
                                    <Star
                                      key={star}
                                      className={`h-4 w-4 ${
                                        star <= review.rating
                                          ? "fill-yellow-400 text-yellow-400"
                                          : "text-gray-300"
                                      }`}
                                    />
                                  ))}
                                  <span className="ml-2 font-semibold">{review.rating}</span>
                                </div>
                              </TableCell>
                              <TableCell className="max-w-md">
                                <p className="text-sm line-clamp-2">{review.comment}</p>
                              </TableCell>
                              <TableCell className="text-sm text-muted-foreground">
                                {review.date}
                              </TableCell>
                              <TableCell>
                                {review.status === 'pending' ? (
                                  <Badge variant="outline" className="bg-yellow-50 text-yellow-700 border-yellow-300">
                                    <Clock className="h-3 w-3 mr-1" />
                                    Pending
                                  </Badge>
                                ) : (
                                  <Badge variant="outline" className="bg-green-50 text-green-700 border-green-300">
                                    <CheckCircle className="h-3 w-3 mr-1" />
                                    Approved
                                  </Badge>
                                )}
                              </TableCell>
                            </TableRow>
                          ))}
                      </TableBody>
                    </Table>
                  ) : (
                    <div className="text-center py-12">
                      <Star className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
                      <p className="text-muted-foreground">
                        You haven't written any reviews yet.
                      </p>
                      <p className="text-sm text-muted-foreground mt-2">
                        Complete a booking to leave a review!
                      </p>
                    </div>
                  )}
                </Card>
              )}
            </motion.div>
          </div>
        </div>
      </div>

      {/* Booking Details Dialog */}
      <Dialog open={showBookingDetails} onOpenChange={setShowBookingDetails}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Booking Details</DialogTitle>
            <DialogDescription>
              Complete information about your booking
            </DialogDescription>
          </DialogHeader>
          
          {selectedBooking && (
            <div className="space-y-6">
              {/* Booking Status */}
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-semibold">Booking #{selectedBooking.id}</h3>
                  <p className="text-sm text-muted-foreground">
                    Booking Number: {selectedBooking.bookingNumber || selectedBooking.id}
                  </p>
                </div>
                {getStatusBadge(selectedBooking.status)}
              </div>

              <Separator />

              {/* Vehicle Information */}
              <div className="space-y-3">
                <h4 className="font-semibold flex items-center gap-2">
                  <Car className="h-4 w-4" />
                  Vehicle Information
                </h4>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <p className="text-muted-foreground">Vehicle Name</p>
                    <p className="font-medium">{selectedBooking.vehicleName || selectedBooking.vehicleInfo?.name || "N/A"}</p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">Category</p>
                    <p className="font-medium">{selectedBooking.vehicleInfo?.category || "N/A"}</p>
                  </div>
                </div>
              </div>

              <Separator />

              {/* Driver Information */}
              {selectedBooking.driverInfo && (
                <>
                  <div className="space-y-3">
                    <h4 className="font-semibold flex items-center gap-2">
                      <UserCircle className="h-4 w-4" />
                      Driver Information
                    </h4>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <p className="text-muted-foreground">Driver Name</p>
                        <p className="font-medium">{selectedBooking.driverInfo.name}</p>
                      </div>
                      <div>
                        <p className="text-muted-foreground">Phone</p>
                        <p className="font-medium flex items-center gap-1">
                          <Phone className="h-3 w-3" />
                          {selectedBooking.driverInfo.phone || "Not provided"}
                        </p>
                      </div>
                      <div>
                        <p className="text-muted-foreground">Email</p>
                        <p className="font-medium flex items-center gap-1">
                          <Mail className="h-3 w-3" />
                          {selectedBooking.driverInfo.email}
                        </p>
                      </div>
                      <div>
                        <p className="text-muted-foreground">License Number</p>
                        <p className="font-medium flex items-center gap-1">
                          <Shield className="h-3 w-3" />
                          {selectedBooking.driverInfo.licenseNumber || "Not provided"}
                        </p>
                      </div>
                    </div>
                  </div>
                  <Separator />
                </>
              )}

              {!selectedBooking.driverInfo && (
                <>
                  <div className="bg-muted p-4 rounded-lg">
                    <p className="text-sm text-muted-foreground flex items-center gap-2">
                      <UserCircle className="h-4 w-4" />
                      Driver has not been assigned yet
                    </p>
                  </div>
                  <Separator />
                </>
              )}

              {/* Booking Dates */}
              <div className="space-y-3">
                <h4 className="font-semibold flex items-center gap-2">
                  <Calendar className="h-4 w-4" />
                  Rental Period
                </h4>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <p className="text-muted-foreground">Start Date</p>
                    <p className="font-medium">{selectedBooking.startDate}</p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">End Date</p>
                    <p className="font-medium">{selectedBooking.endDate}</p>
                  </div>
                </div>
              </div>

              <Separator />

              {/* Location Information */}
              <div className="space-y-3">
                <h4 className="font-semibold flex items-center gap-2">
                  <MapPin className="h-4 w-4" />
                  Location Details
                </h4>
                <div className="grid grid-cols-1 gap-4 text-sm">
                  <div>
                    <p className="text-muted-foreground">Pickup Location</p>
                    <p className="font-medium">{selectedBooking.pickupLocation}</p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">Drop-off Location</p>
                    <p className="font-medium">{selectedBooking.dropoffLocation || selectedBooking.dropOffLocation}</p>
                  </div>
                </div>
              </div>

              <Separator />

              {/* Payment Information */}
              <div className="space-y-3">
                <h4 className="font-semibold flex items-center gap-2">
                  <CreditCard className="h-4 w-4" />
                  Payment Information
                </h4>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <p className="text-muted-foreground">Total Amount</p>
                    <p className="text-2xl font-bold text-primary">${selectedBooking.totalPrice}</p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">Payment Status</p>
                    <Badge variant={selectedBooking.paymentStatus === "COMPLETED" ? "default" : "secondary"}>
                      {selectedBooking.paymentStatus || "Pending"}
                    </Badge>
                  </div>
                  {selectedBooking.paymentMethod && (
                    <div>
                      <p className="text-muted-foreground">Payment Method</p>
                      <p className="font-medium">{selectedBooking.paymentMethod}</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Special Requests */}
              {selectedBooking.specialRequests && (
                <>
                  <Separator />
                  <div className="space-y-3">
                    <h4 className="font-semibold flex items-center gap-2">
                      <FileText className="h-4 w-4" />
                      Special Requests
                    </h4>
                    <p className="text-sm bg-muted p-3 rounded-lg">
                      {selectedBooking.specialRequests}
                    </p>
                  </div>
                </>
              )}

              {/* Action Buttons */}
              <div className="flex gap-2 pt-4">
                {/* Show Confirm Payment button for completed bookings with pending payment */}
                {(selectedBooking.status === "completed" || selectedBooking.status === "COMPLETED") && 
                 (selectedBooking.paymentStatus === "pending" || selectedBooking.paymentStatus === "PENDING") && (
                  <Button
                    variant="default"
                    className="bg-green-600 hover:bg-green-700"
                    onClick={() => handleConfirmPayment(selectedBooking.id)}
                  >
                    <CreditCard className="h-4 w-4 mr-2" />
                    Confirm Payment
                  </Button>
                )}
                
                {/* Show Cancel button for pending/confirmed bookings */}
                {(selectedBooking.status === "confirmed" || selectedBooking.status === "CONFIRMED" || 
                  selectedBooking.status === "pending" || selectedBooking.status === "PENDING") && (
                  <Button
                    variant="destructive"
                    onClick={() => {
                      handleCancelBooking(selectedBooking.id);
                      setShowBookingDetails(false);
                    }}
                  >
                    Cancel Booking
                  </Button>
                )}
                <Button
                  variant="outline"
                  onClick={() => setShowBookingDetails(false)}
                >
                  Close
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      <Footer />
    </div>
  );
};

export default UserDashboard;
